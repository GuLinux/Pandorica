cmake_minimum_required(VERSION 2.8)
enable_testing()

set(app_name Pandorica)
project(${app_name})
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=gnu++11 -fstack-protector-all")
add_definitions(-DWT_NO_SLOT_MACROS)
find_package(Wt REQUIRED)
INCLUDE (CheckIncludeFiles)
include(FindPackageHandleStandardArgs)
find_package(Boost REQUIRED COMPONENTS signals system filesystem thread${BOOST_THREAD_LIBRARY_SUFFIX} regex program_options random date_time OPTIONAL_COMPONENTS unit_test_framework )
FIND_PACKAGE(Qt4 )

add_definitions(-DBOOST_SIGNALS_NO_DEPRECATION_WARNING)

include(FindPkgConfig)
message("PKGConfig Executable: ${PKG_CONFIG_EXECUTABLE}")
pkg_check_modules(GRAPHICSMAGICK GraphicsMagick++ REQUIRED)
add_definitions(${GRAPHICSMAGICK_CFLAGS})
#add_definitions(-fno-stack-protector )

include_directories(${Wt_INCLUDE_DIR} ${QT_INCLUDE_DIR} ${CMAKE_SOURCE_DIR} ${GRAPHICSMAGICK_INCLUDE_DIRS} src )

find_path(HAVE_DBO_SQLITE3 Wt/Dbo/backend/Sqlite3)
find_path(HAVE_DBO_MYSQL Wt/Dbo/backend/MySQL)
find_path(HAVE_DBO_POSTGRES Wt/Dbo/backend/Postgres)
FIND_PACKAGE_HANDLE_STANDARD_ARGS(DBO_MYSQL DEFAULT_MSG HAVE_DBO_MYSQL)
FIND_PACKAGE_HANDLE_STANDARD_ARGS(DBO_POSTGRES DEFAULT_MSG HAVE_DBO_POSTGRES)
FIND_PACKAGE_HANDLE_STANDARD_ARGS(DBO_SQLITE3 DEFAULT_MSG HAVE_DBO_SQLITE3)

if(${DBO_MYSQL_FOUND} AND NOT(${DISABLE_MYSQL}) )
  add_definitions(-DHAVE_MYSQL)
  STRING(REGEX REPLACE "wtdbo" "wtdbomysql" Wt_DBOMYSQL_DEBUG_LIBRARY "${Wt_DBO_DEBUG_LIBRARY}")
  STRING(REGEX REPLACE "wtdbo" "wtdbomysql" Wt_DBOMYSQL_LIBRARY "${Wt_DBO_LIBRARY}")
endif(${DBO_MYSQL_FOUND} AND NOT(${DISABLE_MYSQL}) )
if(${DBO_POSTGRES_FOUND} AND NOT (${DISABLE_POSTGRESQL}) )
  add_definitions(-DHAVE_POSTGRES)
endif(${DBO_POSTGRES_FOUND} AND NOT (${DISABLE_POSTGRESQL}) )
if(${DBO_SQLITE3_FOUND})
  add_definitions(-DHAVE_SQLITE3)
endif(${DBO_SQLITE3_FOUND})

set(Wt_CONNECTOR_LIBRARY "${Wt_HTTP_LIBRARY}")
set(Wt_CONNECTOR_DEBUG_LIBRARY ${Wt_HTTP_DEBUG_LIBRARY})

SET(SHARED_FILES_DIR ${CMAKE_INSTALL_PREFIX}/share/${app_name})
add_definitions(-DSHARED_FILES_DIR="${SHARED_FILES_DIR}" )

set(TRANSLATION_FILES files/strings.xml files/strings_it.xml )
INSTALL(FILES ${TRANSLATION_FILES} DESTINATION ${SHARED_FILES_DIR} )
INSTALL(FILES files/title_from_filename_replacements.json DESTINATION ${SHARED_FILES_DIR})
INSTALL(DIRECTORY files/html_templates DESTINATION ${SHARED_FILES_DIR} FILES_MATCHING PATTERN "*.html" )
INSTALL(DIRECTORY files/static DESTINATION ${SHARED_FILES_DIR} )
if(${QT_FOUND})
  INSTALL(FILES files/desktop-files/pandorica.desktop DESTINATION ${CMAKE_INSTALL_PREFIX}/share/applications)
  INSTALL(DIRECTORY files/desktop-files/hicolor DESTINATION ${CMAKE_INSTALL_PREFIX}/share/icons )
endif(${QT_FOUND})

add_subdirectory(src)
add_subdirectory(tests)